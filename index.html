<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSI Pro v11 (Cloud)</title>
    <style>
        /* --- THEMES --- */
        :root {
            --bg: #f4f4f9; --card-bg: #ffffff; --text: #1a1a1a; --border: #ccc;
            --input-bg: #ffffff; --nav-bg: #fff;
            --blue: #007bff; --purple: #9d50bb; --red: #ff4d4d; --green: #28a745; --yellow: #ffc107; --perfect: #00d2ff;
            --dark-grey: #333;
        }
        body.dark-mode {
            --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --border: #444;
            --input-bg: #2d2d2d; --nav-bg: #1e1e1e;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; -webkit-tap-highlight-color: transparent; user-select: none; transition: 0.3s; }
        
        /* LAYOUT */
        .container { max-width: 100%; margin: auto; padding-bottom: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; }
        .header-btns { display: flex; gap: 10px; align-items: center; }
        
        .gear-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; padding: 5px; color: var(--text); }
        .lang-btn { background: var(--blue); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        
        /* Connection Status */
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .status-offline { background: var(--red); }

        /* NAV */
        .machine-nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .m-btn { flex: 1; padding: 12px; font-weight: bold; border: 2px solid var(--border); border-radius: 8px; background: var(--card-bg); color: var(--text); transition: 0.2s; }
        .m-active { background: var(--dark-grey); color: white; border-color: var(--dark-grey); }
        .nav-hidden { display: none !important; }

        /* INFO BAR */
        .info-bar { display: flex; justify-content: space-between; background: var(--card-bg); padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); font-size: 0.85rem; font-weight: bold; align-items: center; }
        .info-pill { background: var(--blue); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* LANES */
        .lane-card { background: var(--card-bg); border: 2px solid var(--border); padding: 12px; margin-bottom: 10px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; position: relative; }
        .lane-header { grid-column: span 2; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 5px; font-weight: bold; }
        
        .smart-tag { font-size: 0.7rem; background: var(--purple); color: white; padding: 2px 6px; border-radius: 10px; display: none; }
        .smart-active .smart-tag { display: inline-block; }

        /* INPUTS */
        label { font-size: 0.7rem; font-weight: bold; display: block; margin-bottom: 2px; text-transform: uppercase; opacity: 0.7; }
        .input-group { display: flex; gap: 5px; }
        input { width: 100%; padding: 12px; font-size: 1.1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text); font-weight: bold; }
        input.density-input:read-only { background: rgba(128,128,128,0.1); color: var(--text); opacity: 0.8; pointer-events: auto; }
        input.density-input:focus { background: var(--input-bg); border-color: var(--blue); outline: none; }

        /* BUTTONS */
        .btn-icon { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 0 12px; cursor: pointer; font-size: 1.2rem; color: var(--text); display: flex; align-items: center; justify-content: center; }
        .btn-icon.locked { background: var(--dark-grey); color: white; border-color: var(--dark-grey); }
        .btn-recheck { color: var(--yellow); border-color: var(--yellow); }
        .btn-hidden { display: none; }

        .result-box { grid-column: span 2; padding: 12px; text-align: center; border-radius: 8px; background: rgba(128,128,128,0.1); border: 2px dashed var(--border); font-weight: bold; cursor: pointer; }
        .result-box span { display: block; }
        .tap-hint { font-size: 0.7rem; opacity: 0.6; font-weight: normal; margin-top: 4px; }

        /* FOOTER STATS */
        .stats-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--dark-grey); color: white; padding: 10px; display: flex; justify-content: space-around; align-items: center; z-index: 10; border-top-left-radius: 15px; border-top-right-radius: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
        .stat-box { text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; display: block; }
        .stat-lbl { font-size: 0.6rem; text-transform: uppercase; opacity: 0.8; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 400px; color: var(--text); max-height: 85vh; overflow-y: auto; }
        .modal h2 { margin-top: 0; font-size: 1.2rem; }
        .modal-opt { margin-bottom: 15px; }
        .modal-btn { width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; font-size: 1rem; cursor: pointer; }
        .modal-btn.secondary { background: var(--dark-grey); }
        .modal-btn.danger { background: var(--red); margin-top: 20px; }
        
        .legal-text { font-size: 0.8rem; line-height: 1.4; color: #888; margin-bottom: 10px; text-align: justify; }
        .legal-header { font-weight: bold; color: var(--text); margin-top: 10px; display: block; }

        /* HISTORY */
        .history-section { margin-top: 20px; padding-bottom: 60px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; background: var(--card-bg); }
        .history-table th, .history-table td { border: 1px solid var(--border); padding: 6px; text-align: center; }
        .history-table th { background: rgba(128,128,128,0.1); }
        .btn-clear { width: 100%; padding: 12px; background: #666; color: white; border: none; margin-top: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .cell-wt { font-weight: bold; font-size: 0.9rem; display: block; }
        .cell-dens { font-size: 0.7rem; opacity: 0.8; display: block; }

        /* COLORS */
        .bg-blue { background-color: var(--perfect) !important; color: #000; border-color: var(--perfect); }
        .bg-green { background-color: var(--green) !important; color: #fff; border-color: var(--green); }
        .bg-yellow { background-color: var(--yellow) !important; color: #000; border-color: var(--yellow); }
        .bg-red { background-color: var(--red) !important; color: #fff; border-color: var(--red); }

        select { width: 100%; padding: 12px; border-radius: 6px; background: var(--input-bg); color: var(--text); border: 1px solid var(--border); font-size: 1rem; }
    </style>
</head>
<body>

<div class="modal-overlay" id="disclaimerModal" style="display:none; z-index: 200;">
    <div class="modal">
        <h2 id="discTitle">‚ö†Ô∏è Unofficial App</h2>
        <div class="legal-text" id="discText"></div>
        <button class="modal-btn" onclick="acceptDisclaimer()" id="btnUnderstand">I UNDERSTAND</button>
        <button class="modal-btn secondary" onclick="toggleLanguage()" id="btnDiscLang">Espa√±ol</button>
    </div>
</div>

<div class="modal-overlay" id="setupWizard" style="display:none;">
    <div class="modal">
        <h2 id="setupTitle">Initial Setup</h2>
        <div class="modal-opt">
            <label id="lblSetMach">Number of Machines</label>
            <select id="setupMachines">
                <option value="1">1 Machine</option>
                <option value="2" selected>2 Machines</option>
            </select>
        </div>
        <div class="modal-opt">
            <label id="lblSetLane">Lane Configuration</label>
            <select id="setupLanes">
                <option value="2">Dual Lane (2)</option>
                <option value="4" selected>Quad Lane (4)</option>
            </select>
        </div>
        <div class="modal-opt">
            <label id="lblSetProd">Default Product</label>
            <select id="setupProd">
                <option value="lunch">Lunch (0.01)</option>
                <option value="bfast">Breakfast (0.017)</option>
            </select>
        </div>
        <button class="modal-btn" onclick="completeSetup()" id="btnStartApp">START APP</button>
    </div>
</div>

<div class="modal-overlay" id="aboutModal">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="aboutTitle">About</h2>
            <button onclick="closeAbout()" style="background:none; border:none; font-size:1.5rem; color:var(--text);">‚úï</button>
        </div>
        <div class="legal-text" id="aboutText"></div>
        <button class="modal-btn secondary" onclick="closeAbout()" id="btnCloseAbout">CLOSE</button>
    </div>
</div>

<div class="modal-overlay" id="settingsMenu">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="menuTitle">Options</h2>
            <button onclick="toggleSettings()" style="background:none; border:none; font-size:1.5rem; color:var(--text);">‚úï</button>
        </div>
        
        <div class="modal-opt">
            <label id="lblMenuTarget">Target Weight (g)</label>
            <input type="number" id="setTarget" inputmode="decimal" oninput="updateTargetFromSettings()" style="background:var(--input-bg);">
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">

        <div class="modal-opt">
            <label id="lblMenuInput">Unlock Method</label>
            <select id="setInputMode" onchange="saveLocalSettings()">
                <option value="button">Lock Button (Default)</option>
                <option value="longpress">Long Press (1s)</option>
                <option value="doubletap">Double Tap</option>
            </select>
        </div>

        <div class="modal-opt">
            <label id="lblMenuMach">Machines</label>
            <select id="setMachines" onchange="saveLocalSettings()">
                <option value="1">1 Machine</option>
                <option value="2">2 Machines</option>
            </select>
        </div>

        <div class="modal-opt">
            <label id="lblMenuLane">Configuration</label>
            <select id="setLanes" onchange="switchProfile()">
                <option value="2">Dual Lane</option>
                <option value="4">Quad Lane</option>
            </select>
        </div>

        <div class="modal-opt">
            <label id="lblMenuProd">Product Mode</label>
            <select id="setProd" onchange="switchProfile()">
                <option value="lunch">Lunch</option>
                <option value="bfast">Breakfast</option>
            </select>
        </div>

        <div class="modal-opt">
            <label id="lblMenuSmart">Smart Mode (Adaptive)</label>
            <select id="setSmart" onchange="saveLocalSettings()">
                <option value="off">Off (Fixed)</option>
                <option value="on">On (Always)</option>
                <option value="auto">Auto (Beta)</option>
            </select>
        </div>

        <div class="modal-opt">
            <label id="lblMenuTheme">Theme</label>
            <select id="setTheme" onchange="toggleTheme()">
                <option value="light">Light Mode</option>
                <option value="dark">Dark Mode</option>
            </select>
        </div>

        <button class="modal-btn secondary" onclick="openAbout()" id="btnMenuAbout">ABOUT / DISCLAIMER</button>
        <button class="modal-btn danger" onclick="factoryReset()" id="btnMenuReset">FACTORY RESET (LOCAL)</button>
    </div>
</div>

<div class="container" id="appContent" style="filter:blur(5px);">
    <div class="header">
        <div style="display:flex; align-items:center;">
            <div id="statusDot" class="status-dot"></div>
            <h1 id="appTitle">DSI Pro</h1>
        </div>
        <div class="header-btns">
            <button class="lang-btn" onclick="toggleLanguage()" id="mainLangBtn">EN/ES</button>
            <button class="gear-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="machine-nav" id="machineNav"></div>

    <div class="info-bar">
        <span id="displayConfig">Quad Lane ‚Ä¢ Lunch</span>
        <span id="displayTarget">Target: --g</span>
    </div>

    <div id="lanesContainer"></div>

    <div class="history-section">
        <label id="lblHistory" style="font-size:0.9rem; margin-bottom:10px;">Shift History</label>
        <div style="overflow-x:auto;">
            <table class="history-table">
                <thead>
                    <tr id="histHeader"></tr>
                </thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-clear" onclick="saveToHistory()" style="background:var(--blue);" id="btnSaveCheck">SAVE CHECK</button>
            <button class="btn-clear" onclick="clearHistory()" id="btnClearTable">CLEAR TABLE</button>
        </div>
    </div>
</div>

<div class="stats-bar">
    <div class="stat-box">
        <span class="stat-val" id="machAvg">--</span>
        <span class="stat-lbl" id="lblAvg">AVG</span>
    </div>
    <div style="width:1px; height:30px; background:rgba(255,255,255,0.3);"></div>
    <div class="stat-box">
        <span class="stat-val" id="stdDev">--</span>
        <span class="stat-lbl" id="lblSD">SD</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA84WGuDvVMTci0KTZHVxDCle8dbiE1XB4",
      authDomain: "dsi-pro-bcb5c.firebaseapp.com",
      databaseURL: "https://dsi-pro-bcb5c-default-rtdb.firebaseio.com",
      projectId: "dsi-pro-bcb5c",
      storageBucket: "dsi-pro-bcb5c.firebasestorage.app",
      messagingSenderId: "545898401770",
      appId: "1:545898401770:web:01928966d9415a9cc82c93"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db; // Expose to global scope for non-module functions
    window.ref = ref;
    window.set = set;
    window.onValue = onValue;
    window.update = update;
    
    // Start App Logic after Firebase Loads
    window.initApp();
</script>

<script>
    // --- GLOBAL STATE ---
    // Config = Local Preferences (Not Synced)
    let config = {
        machines: 2, lanes: 4, product: 'lunch', smart: 'auto', theme: 'light',
        currentMachine: 1, acceptedDisclaimer: false, lang: 'en', inputMode: 'button'
    };

    // Store = Cloud Data (Synced)
    let store = {}; 
    let history = {};
    
    const FACTORS = { lunch: 0.01, bfast: 0.017 };
    let pressTimer; let lastAutoSaveCombo = "";
    
    // --- TRANSLATIONS ---
    const T = {
        en: {
            title: "DSI Pro", target: "Target", newDens: "New Density", tapApply: "TAP TO APPLY", 
            density: "DENSITY", weight: "AVG WEIGHT", smart: "SMART", 
            avg: "AVG", sd: "SD", history: "Shift History", save: "SAVE CHECK", clear: "CLEAR TABLE",
            setupTitle: "Initial Setup", numMach: "Number of Machines", laneConfig: "Lane Configuration", defProd: "Default Product", start: "START APP",
            options: "Options", mach: "Machines", config: "Configuration", prod: "Product Mode", smartMode: "Smart Mode", theme: "Theme", inputMode: "Unlock Method",
            about: "ABOUT / DISCLAIMER", reset: "FACTORY RESET", close: "CLOSE", understand: "I UNDERSTAND",
            lane: "Lane", bfast: "Breakfast", lunch: "Lunch",
            discTitle: "‚ö†Ô∏è Unofficial App",
            discText: `<strong>Disclaimer:</strong> This is an unofficial, non-profit app created by a machine operator, for machine operators. It is not affiliated with, endorsed by, or connected to JBT Corporation. "DSI" and all related trademarks are the property of JBT Corporation. This tool is provided "as is" for informational purposes only.`,
            aboutText: `<span class="legal-header">Unofficial App Disclaimer</span><span class="legal-header">No Affiliation:</span> This application is an independent, unofficial project. It is strictly not affiliated with, authorized, maintained, sponsored, or endorsed by JBT Corporation or any of its affiliates or subsidiaries.<span class="legal-header">Trademarks:</span> "DSI" and all associated names, marks, emblems, and images are registered trademarks of JBT Corporation.<span class="legal-header">Limitation of Liability:</span> This tool is provided "as is". The developer assumes no responsibility for any errors or issues that arise from using this app.`
        },
        es: {
            title: "DSI Pro", target: "Meta", newDens: "Nueva Densidad", tapApply: "TOCA PARA APLICAR", 
            density: "DENSIDAD", weight: "PESO PROM.", smart: "INTEL", 
            avg: "PROM", sd: "DE", history: "Historial", save: "GUARDAR", clear: "BORRAR TABLA",
            setupTitle: "Configuraci√≥n Inicial", numMach: "N√∫mero de M√°quinas", laneConfig: "Config. Carriles", defProd: "Producto", start: "INICIAR",
            options: "Opciones", mach: "M√°quinas", config: "Configuraci√≥n", prod: "Modo Producto", smartMode: "Modo Inteligente", theme: "Tema", inputMode: "M√©todo de Desbloqueo",
            about: "ACERCA DE / LEGAL", reset: "REINICIO DE F√ÅBRICA", close: "CERRAR", understand: "ENTIENDO",
            lane: "Carril", bfast: "Desayuno", lunch: "Almuerzo",
            discTitle: "‚ö†Ô∏è App No Oficial",
            discText: `<strong>Aviso Legal:</strong> Esta es una aplicaci√≥n no oficial y sin fines de lucro creada por un operador para operadores. No est√° afiliada, respaldada ni conectada con JBT Corporation. "DSI" y todas las marcas relacionadas son propiedad de JBT Corporation. Esta herramienta se proporciona "tal cual" solo con fines informativos.`,
            aboutText: `<span class="legal-header">Aviso de App No Oficial</span><span class="legal-header">Sin Afiliaci√≥n:</span> Esta aplicaci√≥n es un proyecto independiente. No est√° afiliada, autorizada ni respaldada por JBT Corporation.<span class="legal-header">Marcas Registradas:</span> "DSI" y las marcas asociadas son propiedad de JBT Corporation.<span class="legal-header">Limitaci√≥n de Responsabilidad:</span> Esta herramienta se ofrece "tal cual". El desarrollador no asume responsabilidad por errores o problemas derivados de su uso.`
        }
    };

    // Called by Module Script
    window.initApp = function() {
        const savedConfig = localStorage.getItem('dsi_config_v11');
        if (savedConfig) config = JSON.parse(savedConfig);

        updateText();
        
        if(!config.acceptedDisclaimer) {
            document.getElementById('disclaimerModal').style.display = 'flex';
        } else {
            // First run check is less relevant with cloud, but we keep setup wizard for local preferences
            const hasSetup = localStorage.getItem('dsi_setup_done');
            if (!hasSetup) document.getElementById('setupWizard').style.display = 'flex';
            else {
                document.getElementById('appContent').style.filter = 'none';
                startCloudSync(); // Connect to Cloud
            }
        }
        
        applyTheme();
        renderInterface();
    };

    // --- CLOUD SYNC LOGIC ---
    let dbRef_Store;
    let dbRef_History;
    let unsubStore = null;   // NEW: Tracks active store listener
    let unsubHistory = null; // NEW: Tracks active history listener

    function startCloudSync() {
        if(!window.db) { setTimeout(startCloudSync, 500); return; } // Wait for SDK
        
        const pathKey = `M${config.currentMachine}/${config.product}_${config.lanes}L`;
        const dot = document.getElementById('statusDot');
        
        // THE FIX: Officially "hang up" old listeners before switching machines
        if (unsubStore) unsubStore();
        if (unsubHistory) unsubHistory();

        dbRef_Store = window.ref(window.db, `stores/${pathKey}`);
        dbRef_History = window.ref(window.db, `histories/${pathKey}`);

        // Listen for Store Changes (and save the hang-up function to unsubStore)
        unsubStore = window.onValue(dbRef_Store, (snapshot) => {
            dot.className = "status-dot status-online";
            const val = snapshot.val();
            if(val) {
                store = val;
                // Update UI, but carefully
                updateUIFromCloud();
            } else {
                // Initialize default if empty
                if(!store.target) {
                    const defaultTarget = config.product === 'bfast' ? '63' : '102';
                    store = { target: defaultTarget, lanes: Array(config.lanes).fill().map(() => ({ d:'', w:'', attempts: 0, smartActive: false, lastD: null, lastW: null, locked: true })) };
                    window.set(dbRef_Store, store);
                }
            }
        }, (error) => {
            dot.className = "status-dot status-offline";
            console.error(error);
        });

        // Listen for History Changes (and save the hang-up function to unsubHistory)
        unsubHistory = window.onValue(dbRef_History, (snapshot) => {
            const val = snapshot.val();
            history = val || [];
            renderHistoryTable();
        });
    }

    function updateUIFromCloud() {
        const txt = T[config.lang];
        
        // Update Target
        const tEl = document.getElementById('setTarget');
        if(document.activeElement !== tEl) {
            tEl.value = store.target;
            document.getElementById('displayTarget').innerText = `${txt.target}: ${store.target}g`;
        }

        // Update Lanes
        for(let i=1; i<=config.lanes; i++) {
            const lane = store.lanes[i-1];
            
            // Update Density Input
            const dEl = document.getElementById(`currDens-${i}`);
            if(document.activeElement !== dEl) {
                dEl.value = lane.d;
                if(lane.locked) {
                    dEl.readOnly = true; dEl.style.borderColor = 'var(--border)';
                    if(config.inputMode === 'button') { document.getElementById(`lockDens-${i}`).className = 'btn-icon locked'; document.getElementById(`lockDens-${i}`).innerText = 'üîí'; }
                } else {
                    dEl.readOnly = false; dEl.style.borderColor = 'var(--blue)';
                    if(config.inputMode === 'button') { document.getElementById(`lockDens-${i}`).className = 'btn-icon'; document.getElementById(`lockDens-${i}`).innerText = 'üîì'; }
                }
            }

            // Update Weight Input
            const wEl = document.getElementById(`avgWt-${i}`);
            if(document.activeElement !== wEl) {
                wEl.value = lane.w || '';
            }

            // Update Smart Tag
            if(config.smart === 'on' || (config.smart === 'auto' && lane.smartActive)) {
                document.getElementById(`card-${i}`).classList.add('smart-active');
            } else {
                document.getElementById(`card-${i}`).classList.remove('smart-active');
            }
        }
        calculate(false); // Calc without writing back to cloud to avoid loops
    }

    function pushToCloud() {
        if(dbRef_Store) window.set(dbRef_Store, store);
    }

    function pushHistoryToCloud() {
        if(dbRef_History) window.set(dbRef_History, history);
    }

    // --- STANDARD APP LOGIC ---

    function toggleLanguage() { config.lang = config.lang === 'en' ? 'es' : 'en'; updateText(); renderInterface(); saveLocalSettings(); }

    function updateText() {
        const txt = T[config.lang];
        document.getElementById('discTitle').innerText = txt.discTitle;
        document.getElementById('discText').innerHTML = txt.discText;
        document.getElementById('btnUnderstand').innerText = txt.understand;
        document.getElementById('setupTitle').innerText = txt.setupTitle;
        document.getElementById('lblSetMach').innerText = txt.numMach;
        document.getElementById('lblSetLane').innerText = txt.laneConfig;
        document.getElementById('lblSetProd').innerText = txt.defProd;
        document.getElementById('btnStartApp').innerText = txt.start;
        document.getElementById('appTitle').innerText = txt.title;
        document.getElementById('lblHistory').innerText = txt.history;
        document.getElementById('btnSaveCheck').innerText = txt.save;
        document.getElementById('btnClearTable').innerText = txt.clear;
        document.getElementById('lblAvg').innerText = txt.avg;
        document.getElementById('lblSD').innerText = txt.sd;
        document.getElementById('menuTitle').innerText = txt.options;
        document.getElementById('lblMenuTarget').innerText = `${txt.target} (g)`;
        document.getElementById('lblMenuMach').innerText = txt.mach;
        document.getElementById('lblMenuLane').innerText = txt.config;
        document.getElementById('lblMenuProd').innerText = txt.prod;
        document.getElementById('lblMenuSmart').innerText = txt.smartMode;
        document.getElementById('lblMenuTheme').innerText = txt.theme;
        document.getElementById('lblMenuInput').innerText = txt.inputMode;
        document.getElementById('btnMenuAbout').innerText = txt.about;
        document.getElementById('btnMenuReset').innerText = txt.reset;
        document.getElementById('aboutTitle').innerText = txt.about;
        document.getElementById('aboutText').innerHTML = txt.aboutText;
        document.getElementById('btnCloseAbout').innerText = txt.close;
    }

    function acceptDisclaimer() {
        config.acceptedDisclaimer = true;
        saveLocalSettings();
        document.getElementById('disclaimerModal').style.display = 'none';
        
        const hasSetup = localStorage.getItem('dsi_setup_done');
        if (!hasSetup) document.getElementById('setupWizard').style.display = 'flex';
        else {
            document.getElementById('appContent').style.filter = 'none';
            startCloudSync();
        }
    }

    function completeSetup() {
        config.machines = parseInt(document.getElementById('setupMachines').value);
        config.lanes = parseInt(document.getElementById('setupLanes').value);
        config.product = document.getElementById('setupProd').value;
        localStorage.setItem('dsi_setup_done', 'true');
        saveLocalSettings();
        document.getElementById('setupWizard').style.display = 'none';
        document.getElementById('appContent').style.filter = 'none';
        
        renderInterface();
        startCloudSync(); // Initialize cloud connection
    }

    function renderInterface() {
        const txt = T[config.lang];
        const nav = document.getElementById('machineNav');
        const title = document.getElementById('appTitle');

        if (config.machines === 1) {
            nav.className = 'machine-nav nav-hidden';
            config.currentMachine = 1;
        } else {
            nav.className = 'machine-nav';
            nav.innerHTML = '';
            for(let i=1; i<=config.machines; i++) {
                const btn = document.createElement('button');
                btn.className = `m-btn ${config.currentMachine === i ? 'm-active' : ''}`;
                btn.innerText = `DSI ${i}`;
                btn.onclick = () => switchMachine(i);
                nav.appendChild(btn);
            }
        }

        const prodName = config.product === 'lunch' ? txt.lunch : txt.bfast;
        document.getElementById('displayConfig').innerText = `${config.lanes} ${txt.lane} ‚Ä¢ ${prodName}`;
        
        // Update Options
        document.getElementById('setMachines').value = config.machines;
        document.getElementById('setLanes').value = config.lanes;
        document.getElementById('setProd').value = config.product;
        document.getElementById('setSmart').value = config.smart;
        document.getElementById('setTheme').value = config.theme;
        document.getElementById('setInputMode').value = config.inputMode;

        const container = document.getElementById('lanesContainer');
        container.innerHTML = '';
        for(let i=1; i<=config.lanes; i++) {
            let labelText = txt.density;
            if(config.inputMode === 'longpress') labelText += " (HOLD)";
            if(config.inputMode === 'doubletap') labelText += " (x2)";

            const btnHtml = config.inputMode === 'button' ? 
                `<button class="btn-icon" id="lockDens-${i}" onmousedown="event.preventDefault()" onclick="toggleLock(${i})">üîí</button>` : 
                `<button class="btn-icon btn-hidden" id="lockDens-${i}">üîí</button>`;

            container.innerHTML += `
                <div class="lane-card" id="card-${i}">
                    <div class="lane-header"><span>${txt.lane} ${i}</span><span class="smart-tag" id="tag-${i}">${txt.smart}</span></div>
                    <div>
                        <label>${labelText}</label>
                        <div class="input-group">
                            <input type="number" id="currDens-${i}" class="density-input" step="0.001" readonly inputmode="decimal" oninput="handleInput(${i})" onblur="lockOnBlur(${i})">
                            ${btnHtml}
                        </div>
                    </div>
                    <div>
                        <label>${txt.weight}</label>
                        <div class="input-group">
                            <input type="number" id="avgWt-${i}" inputmode="decimal" oninput="handleWeightInput(${i})" onblur="checkAutoSave()">
                            <button class="btn-icon btn-recheck" onclick="recheckLane(${i})">‚Üª</button>
                        </div>
                    </div>
                    <div class="result-box" id="resBox-${i}" onclick="applyResult(${i})">
                        <span id="resText-${i}">${txt.newDens}: --</span><span class="tap-hint">${txt.tapApply}</span>
                    </div>
                    <input type="hidden" id="calcVal-${i}">
                </div>
            `;
        }
        
        // Listeners
        for(let i=1; i<=config.lanes; i++) {
            const el = document.getElementById(`currDens-${i}`);
            if(config.inputMode === 'longpress') {
                el.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { unlockAndFocus(i); }, 800); });
                el.addEventListener('touchend', () => clearTimeout(pressTimer));
                el.addEventListener('mousedown', () => { pressTimer = setTimeout(() => { unlockAndFocus(i); }, 800); });
                el.addEventListener('mouseup', () => clearTimeout(pressTimer));
            } else if (config.inputMode === 'doubletap') {
                el.ondblclick = function() { unlockAndFocus(i); };
            }
        }
        
        // Note: We don't call loadProfileData here because standard loading happens via Cloud callback
    }

    function unlockAndFocus(i) {
        const el = document.getElementById(`currDens-${i}`);
        el.readOnly = false;
        el.focus(); 
        el.style.borderColor = 'var(--blue)';
        
        store.lanes[i-1].locked = false; // Update local state
        pushToCloud(); // Sync lock status

        if(config.inputMode === 'button') {
            document.getElementById(`lockDens-${i}`).className = 'btn-icon';
            document.getElementById(`lockDens-${i}`).innerText = 'üîì';
        }
    }

    function toggleLock(i) {
        // Just toggle local state and push. UI update handles visual
        store.lanes[i-1].locked = !store.lanes[i-1].locked;
        
        const el = document.getElementById(`currDens-${i}`);
        if(!store.lanes[i-1].locked) {
            el.readOnly = false;
            setTimeout(() => { el.focus(); el.style.borderColor = 'var(--blue)'; }, 50);
        } else {
            el.readOnly = true; el.style.borderColor = 'var(--border)';
        }
        pushToCloud();
    }

    function updateTargetFromSettings() {
        const val = document.getElementById('setTarget').value;
        store.target = val;
        document.getElementById('displayTarget').innerText = `${T[config.lang].target}: ${val}g`;
        calculate(true);
    }

    function handleWeightInput(i) {
        store.lanes[i-1].w = document.getElementById(`avgWt-${i}`).value;
        calculate(true);
    }

    function handleInput(i) {
        store.lanes[i-1].d = document.getElementById(`currDens-${i}`).value;
        calculate(true);
    }

    function lockOnBlur(i) {
        setTimeout(() => {
            const el = document.getElementById(`currDens-${i}`);
            if(document.activeElement === el) return;
            store.lanes[i-1].locked = true;
            store.lanes[i-1].d = el.value;
            pushToCloud();
        }, 150);
    }

    // --- AUTO SAVE ---
    function checkAutoSave() {
        let currentCombo = "";
        let allFilled = true;
        for(let i=1; i<=config.lanes; i++) {
            const w = document.getElementById(`avgWt-${i}`).value;
            if(!w) { allFilled = false; break; }
            currentCombo += w + ",";
        }
        if(allFilled && currentCombo !== lastAutoSaveCombo) {
            lastAutoSaveCombo = currentCombo;
            saveToHistory();
        }
    }

    function calculate(writeToCloud) {
        if(!store || !store.lanes) return; // Guard against empty store

        const target = parseFloat(store.target);
        const baseK = FACTORS[config.product];
        const txt = T[config.lang];
        let weights = []; let count = 0;

        for(let i=1; i<=config.lanes; i++) {
            const currD = parseFloat(store.lanes[i-1].d);
            const currW = parseFloat(store.lanes[i-1].w);
            const lane = store.lanes[i-1];
            const resText = document.getElementById(`resText-${i}`);
            const hiddenVal = document.getElementById(`calcVal-${i}`);
            const card = document.getElementById(`card-${i}`);

            if(!isNaN(target) && !isNaN(currD) && !isNaN(currW)) {
                const diff = currW - target;
                let activeK = baseK;

                const isSmart = config.smart === 'on' || (config.smart === 'auto' && lane.smartActive);
                if(isSmart && lane.lastD !== null && lane.lastW !== null) {
                    let dDelta = currD - lane.lastD;
                    let wDelta = currW - lane.lastW;
                    if(Math.abs(wDelta) > 0.5 && Math.abs(dDelta) > 0.001) {
                        let observedK = dDelta / wDelta;
                        observedK = Math.max(baseK * 0.5, Math.min(observedK, baseK * 5));
                        activeK = (observedK * 0.6) + (baseK * 0.4);
                    }
                }

                const newD = currD + (diff * activeK);
                hiddenVal.value = newD.toFixed(3);
                resText.innerText = `${txt.newDens}: ` + newD.toFixed(3);

                const absDiff = Math.abs(diff);
                card.className = "lane-card"; 
                if(isSmart) card.classList.add('smart-active');
                if (absDiff <= 0.5) card.classList.add('bg-blue');
                else if (absDiff <= 2) card.classList.add('bg-green');
                else if (absDiff <= 3) card.classList.add('bg-yellow');
                else card.classList.add('bg-red');

                weights.push(currW); count++;
            } else {
                resText.innerText = `${txt.newDens}: --`; hiddenVal.value = "";
                card.className = "lane-card";
                if(config.smart === 'on' || (config.smart === 'auto' && lane.smartActive)) card.classList.add('smart-active');
            }
        }

        if(count > 0) {
            const mean = weights.reduce((a, b) => a + b, 0) / count;
            document.getElementById('machAvg').innerText = mean.toFixed(1);
            if(count > 1) {
                const v = weights.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / count;
                document.getElementById('stdDev').innerText = Math.sqrt(v).toFixed(2);
            } else { document.getElementById('stdDev').innerText = "--"; }
        } else { document.getElementById('machAvg').innerText = "--"; document.getElementById('stdDev').innerText = "--"; }
        
        if(writeToCloud) pushToCloud();
    }

    function applyResult(idx) {
        const val = document.getElementById(`calcVal-${idx}`).value;
        const currD = parseFloat(store.lanes[idx-1].d);
        const currW = parseFloat(store.lanes[idx-1].w);
        const lane = store.lanes[idx-1];

        if(val && !isNaN(currD)) {
            lane.lastD = currD; lane.lastW = currW;
            const target = parseFloat(store.target);
            if (Math.abs(currW - target) > 2) {
                lane.attempts++;
                if(config.smart === 'auto' && lane.attempts >= 2) {
                    lane.smartActive = true; 
                    document.getElementById(`card-${idx}`).classList.add('smart-active');
                }
            } else { lane.attempts = 0; }

            lane.d = val;
            lane.w = '';
            lane.locked = true; // Auto lock on apply

            lastAutoSaveCombo = "";
            calculate(true); // Pushes new density/cleared weight/lock status
        }
    }

    function recheckLane(idx) {
        // 1. Clear the data in the cloud store
        store.lanes[idx-1].w = '';
        
        // 2. THE FIX: Explicitly clear the physical screen before focusing
        document.getElementById(`avgWt-${idx}`).value = '';
        
        // 3. Reset auto-save and put cursor back in the box
        lastAutoSaveCombo = ""; 
        document.getElementById(`avgWt-${idx}`).focus();
        
        // 4. Calculate and push the blank state to the cloud
        calculate(true);
    }

    function switchMachine(m) { config.currentMachine = m; saveLocalSettings(); renderInterface(); startCloudSync(); }
    function switchProfile() { 
        config.lanes = parseInt(document.getElementById('setLanes').value);
        config.product = document.getElementById('setProd').value;
        saveLocalSettings(); renderInterface(); startCloudSync();
    }
    function toggleSettings() { const m = document.getElementById('settingsMenu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function openAbout() { document.getElementById('settingsMenu').style.display = 'none'; document.getElementById('aboutModal').style.display = 'flex'; }
    function closeAbout() { document.getElementById('aboutModal').style.display = 'none'; document.getElementById('settingsMenu').style.display = 'flex'; }
    function saveLocalSettings() {
        config.machines = parseInt(document.getElementById('setMachines').value);
        config.smart = document.getElementById('setSmart').value;
        config.inputMode = document.getElementById('setInputMode').value;
        localStorage.setItem('dsi_config_v11', JSON.stringify(config));
    }
    function toggleTheme() { config.theme = document.getElementById('setTheme').value; applyTheme(); saveLocalSettings(); }
    function applyTheme() { if(config.theme === 'dark') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); }
    function factoryReset() { if(confirm("Erase LOCAL settings? Cloud data remains.")) { localStorage.clear(); location.reload(); } }

    function saveToHistory() {
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const avg = document.getElementById('machAvg').innerText;
        let row = { time, avg, lanes: [] };
        for(let i=1; i<=config.lanes; i++) {
             const wt = store.lanes[i-1].w;
             const calc = document.getElementById(`calcVal-${i}`).value;
             const dens = store.lanes[i-1].d;
             row.lanes.push({ w: wt ? `${wt}g` : '--', d: calc || dens || '--' });
        }
        history.unshift(row);
        // Limit history to 50 items to save bandwidth/space
        if(history.length > 50) history.pop();
        pushHistoryToCloud();
    }
    function renderHistoryTable() {
        const txt = T[config.lang];
        let hHtml = `<th>${txt.thTime || 'Time'}</th><th>${txt.avg}</th>`;
        for(let i=1; i<=config.lanes; i++) hHtml += `<th>L${i}</th>`;
        document.getElementById('histHeader').innerHTML = hHtml;
        document.getElementById('histBody').innerHTML = history.map(r => {
            let cells = `<td>${r.time}</td><td>${r.avg}</td>`;
            r.lanes.forEach(l => { cells += `<td><span class="cell-wt">${l.w}</span><span class="cell-dens">${l.d}</span></td>`; });
            return `<tr>${cells}</tr>`;
        }).join('');
    }
    function clearHistory() { if(confirm("Clear history?")) { history = []; pushHistoryToCloud(); } }
</script>
</body>
</html>
